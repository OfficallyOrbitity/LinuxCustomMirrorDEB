#!/bin/bash
# ==========================================
# Netplan Setup Tool v1.1
# Safe interactive Netplan configurator (modern syntax)
# ==========================================

set -e

CONFIG_FILE="/etc/netplan/00-installer-config.yaml"

echo "🌐 Welcome to the Netplan Configuration Tool"
echo "------------------------------------------"
echo "This tool will help you create or replace a Netplan configuration file."
echo ""

# 1️⃣ Ask for network interface
echo "Available interfaces:"
ip -o link show | awk -F': ' '{print $2}' | grep -v "lo"
echo ""
read -rp "Enter the network interface to configure (e.g. enp0s3): " IFACE

# 2️⃣ Ask for static IP, gateway, and DNS
read -rp "Enter the static IP address with subnet (e.g. 192.168.1.10/24): " IPADDR
read -rp "Enter the gateway IP (e.g. 192.168.1.1): " GATEWAY
read -rp "Enter DNS servers (comma-separated, e.g. 8.8.8.8,1.1.1.1): " DNS

# 3️⃣ Ask for DHCP toggle
read -rp "Do you want to disable DHCP? (y/n): " DHCP_CHOICE
if [[ "$DHCP_CHOICE" =~ ^[Yy]$ ]]; then
    DHCP="false"
else
    DHCP="true"
fi

# 4️⃣ Generate YAML safely
echo ""
echo "🛠️ Generating new Netplan configuration..."
sudo mkdir -p /etc/netplan

sudo tee "$CONFIG_FILE" > /dev/null <<EOF
# This file was automatically generated by netplan-setup.sh
network:
  version: 2
  renderer: NetworkManager
  ethernets:
    $IFACE:
      dhcp4: $DHCP
EOF

if [[ "$DHCP" == "false" ]]; then
sudo tee -a "$CONFIG_FILE" > /dev/null <<EOF
      addresses:
        - $IPADDR
      routes:
        - to: default
          via: $GATEWAY
      nameservers:
        addresses: [${DNS// /}]
EOF
fi

# 5️⃣ Preview config
echo ""
echo "✅ Generated configuration:"
echo "------------------------------------------"
cat "$CONFIG_FILE"
echo "------------------------------------------"

# 6️⃣ Ask user to apply changes
read -rp "Do you want to apply this configuration now? (y/n): " APPLY
if [[ "$APPLY" =~ ^[Yy]$ ]]; then
    echo "🔧 Applying configuration..."
    sudo netplan apply && echo "✅ Network configuration applied successfully."
else
    echo "⚠️ Configuration saved but not applied."
fi
